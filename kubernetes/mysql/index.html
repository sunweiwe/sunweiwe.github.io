<!doctype html><html lang=en-us>
<head>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.7.0/style.min.css>
<link rel=stylesheet href=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/default.min.css>
<script defer crossorigin=anonymous src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js onload=hljs.highlightAll()></script>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>stateful 部署 mysql</title>
<link rel=stylesheet href=https://sunweiwe.github.io/style.min.d9712c7529c6273cae9cbd0ed688f97cbe37e248317298145303b71169db98c5.css integrity="sha256-2XEsdSnGJzyunL0O1oj5fL434kgxcpgUUwO3EWnbmMU=" media=screen>
<link rel="shortcut icon" type=image/x-icon href=favicon.ico>
</head>
<body>
<script>localStorage.getItem("prefer-theme")==="light"&&document.body.classList.remove('dark')</script>
<header>
<div class=header-common>
<div>
┏━━━━━━━━━━━━━━━┓<br>
┇ <a class=logo href=https://sunweiwe.github.io/>sunweiwe/blog</a> ┇
<button id=theme-toggle text=toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<br>
┗━━━━━━━━━━━━━━━┛
</div>
<div>关于代码，关于生活.</div><br>
</div>
<p>
<nav>
<a href=https://sunweiwe.github.io/><b>Home</b></a>
| <a href=/posts/><b>Posts</b></a>
| <a href=/tags/><b>Tags</b></a>
| <a href=/search/><b>Search</b></a>
</nav>
</p>
</header>
<main>
<article class=post-content>
<h1 class=title>stateful 部署 mysql</h1>
<b><time>24.10.2022</time></b>
<a href=/%20/tags/kubernetes>#kubernetes</a>
<div>
<p>kubernetes 使用 stateful 方式部署 mysql</p>
<h2 id=部署-nfs-server>部署 nfs server </h2><ul>
<li>安装软件包</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>yum install -y rpcbind nfs-utils
</code></pre></div><ul>
<li>修改 /etc/exports</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>  /hone/nfs/ <span style=color:#ed9d13>\*</span>(insecure,rw,sync,no_root_squash)
</code></pre></div><ul>
<li>启动 nfs 服务</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir /home/nfs

systemctl <span style=color:#24909d>enable</span> rpcbind
systemctl <span style=color:#24909d>enable</span> nfs-server

systemctl start rpcbind
systemctl start nfs-server
exportfs -r
exportfs
</code></pre></div><h2 id=创建-rabc>创建 RABC </h2><h3 id=用户创建-nfs-client>用户创建 nfs client </h3><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#6ab825;font-weight:700>apiVersion</span>:<span style=color:#666> </span>v1<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>kind</span>:<span style=color:#666> </span>ServiceAccount<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>metadata</span>:<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>nfs-client-provisioner<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>namespace</span>:<span style=color:#666> </span>default<span style=color:#666>
</span><span style=color:#666></span><span style=color:#447fcf;text-decoration:underline>---</span><span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>kind</span>:<span style=color:#666> </span>ClusterRole<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>apiVersion</span>:<span style=color:#666> </span>rbac.authorization.k8s.io/v1<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>metadata</span>:<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>nfs-client-provisioner-runner<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>rules</span>:<span style=color:#666>
</span><span style=color:#666>  </span>- <span style=color:#6ab825;font-weight:700>apiGroups</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;&#39;</span>]<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>resources</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;persistentvolumes&#39;</span>]<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>verbs</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;get&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;list&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;watch&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;create&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;delete&#39;</span>]<span style=color:#666>
</span><span style=color:#666>  </span>- <span style=color:#6ab825;font-weight:700>apiGroups</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;&#39;</span>]<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>resources</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;persistentvolumeclaims&#39;</span>]<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>verbs</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;get&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;list&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;watch&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;update&#39;</span>]<span style=color:#666>
</span><span style=color:#666>  </span>- <span style=color:#6ab825;font-weight:700>apiGroups</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;storage.k8s.io&#39;</span>]<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>resources</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;storageclasses&#39;</span>]<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>verbs</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;get&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;list&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;watch&#39;</span>]<span style=color:#666>
</span><span style=color:#666>  </span>- <span style=color:#6ab825;font-weight:700>apiGroups</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;&#39;</span>]<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>resources</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;events&#39;</span>]<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>verbs</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;create&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;update&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;patch&#39;</span>]<span style=color:#666>
</span><span style=color:#666></span><span style=color:#447fcf;text-decoration:underline>---</span><span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>kind</span>:<span style=color:#666> </span>ClusterRoleBinding<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>apiVersion</span>:<span style=color:#666> </span>rbac.authorization.k8s.io/v1<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>metadata</span>:<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>run-nfs-client-provisioner<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>subjects</span>:<span style=color:#666>
</span><span style=color:#666>  </span>- <span style=color:#6ab825;font-weight:700>kind</span>:<span style=color:#666> </span>ServiceAccount<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>nfs-client-provisioner<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>namespace</span>:<span style=color:#666> </span>default<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>roleRef</span>:<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>kind</span>:<span style=color:#666> </span>ClusterRole<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>nfs-client-provisioner-runner<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>apiGroup</span>:<span style=color:#666> </span>rbac.authorization.k8s.io<span style=color:#666>
</span><span style=color:#666></span><span style=color:#447fcf;text-decoration:underline>---</span><span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>kind</span>:<span style=color:#666> </span>Role<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>apiVersion</span>:<span style=color:#666> </span>rbac.authorization.k8s.io/v1<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>metadata</span>:<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>leader-locking-nfs-client-provisioner<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>namespace</span>:<span style=color:#666> </span>default<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>rules</span>:<span style=color:#666>
</span><span style=color:#666>  </span>- <span style=color:#6ab825;font-weight:700>apiGroups</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;&#39;</span>]<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>resources</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;endpoints&#39;</span>]<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>verbs</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;get&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;list&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;watch&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;create&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;update&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;patch&#39;</span>]<span style=color:#666>
</span><span style=color:#666></span><span style=color:#447fcf;text-decoration:underline>---</span><span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>kind</span>:<span style=color:#666> </span>RoleBinding<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>apiVersion</span>:<span style=color:#666> </span>rbac.authorization.k8s.io/v1<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>metadata</span>:<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>leader-locking-nfs-client-provisioner<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>namespace</span>:<span style=color:#666> </span>default<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>subjects</span>:<span style=color:#666>
</span><span style=color:#666>  </span>- <span style=color:#6ab825;font-weight:700>kind</span>:<span style=color:#666> </span>ServiceAccount<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>nfs-client-provisioner<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>namespace</span>:<span style=color:#666> </span>default<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>roleRef</span>:<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>kind</span>:<span style=color:#666> </span>Role<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>leader-locking-nfs-client-provisioner<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>apiGroup</span>:<span style=color:#666> </span>rbac.authorization.k8s.io<span style=color:#666>
</span></code></pre></div><h2 id=部署-nfs-client>部署 nfs client </h2><h3 id=用于自动创建-pvc>用于自动创建 pvc </h3><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#6ab825;font-weight:700>apiVersion</span>:<span style=color:#666> </span>apps/v1<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>kind</span>:<span style=color:#666> </span>Deployment<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>metadata</span>:<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>nfs-client-provisioner<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>labels</span>:<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>app</span>:<span style=color:#666> </span>nfs-client-provisioner<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>namespace</span>:<span style=color:#666> </span>default<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>spec</span>:<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>replicas</span>:<span style=color:#666> </span><span style=color:#3677a9>1</span><span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>strategy</span>:<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>type</span>:<span style=color:#666> </span>Recreate<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>selector</span>:<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>matchLabels</span>:<span style=color:#666>
</span><span style=color:#666>      </span><span style=color:#6ab825;font-weight:700>app</span>:<span style=color:#666> </span>nfs-client-provisioner<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>template</span>:<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>metadata</span>:<span style=color:#666>
</span><span style=color:#666>      </span><span style=color:#6ab825;font-weight:700>labels</span>:<span style=color:#666>
</span><span style=color:#666>        </span><span style=color:#6ab825;font-weight:700>app</span>:<span style=color:#666> </span>nfs-client-provisioner<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>spec</span>:<span style=color:#666>
</span><span style=color:#666>      </span><span style=color:#6ab825;font-weight:700>serviceAccountName</span>:<span style=color:#666> </span>nfs-client-provisioner<span style=color:#666>
</span><span style=color:#666>      </span><span style=color:#6ab825;font-weight:700>containers</span>:<span style=color:#666>
</span><span style=color:#666>        </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>nfs-client-provisioner<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>image</span>:<span style=color:#666> </span>registry.cn-hangzhou.aliyuncs.com/jimywu/nfs-subdir-external-provisioner:v4.0.0<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>volumeMounts</span>:<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>nfs-client-root<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>mountPath</span>:<span style=color:#666> </span>/persistentvolumes<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>env</span>:<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>PROVISIONER_NAME<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>value</span>:<span style=color:#666> </span>k8s-sigs.io/nfs-subdir-external-provisioner<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>NFS_SERVER<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>value</span>:<span style=color:#666> </span><span style=color:#3677a9>10.0.24.13</span><span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>NFS_PATH<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>value</span>:<span style=color:#666> </span>/home/nfs<span style=color:#666>
</span><span style=color:#666>      </span><span style=color:#6ab825;font-weight:700>volumes</span>:<span style=color:#666>
</span><span style=color:#666>        </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>nfs-client-root<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>nfs</span>:<span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>server</span>:<span style=color:#666> </span><span style=color:#3677a9>10.0.24.13</span><span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>path</span>:<span style=color:#666> </span>/home/nfs<span style=color:#666>
</span></code></pre></div><h2 id=创建-storageclass>创建 StorageClass </h2><h3 id=用于-mysql-自动扩容或者所容绑定-pvc>用于 mysql 自动扩容或者所容绑定 pvc </h3><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#6ab825;font-weight:700>apiVersion</span>:<span style=color:#666> </span>storage.k8s.io/v1<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>kind</span>:<span style=color:#666> </span>StorageClass<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>metadata</span>:<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>mysql-storage<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>provisioner</span>:<span style=color:#666> </span>k8s-sigs.io/nfs-subdir-external-provisioner<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>reclaimPolicy</span>:<span style=color:#666> </span>Retain<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>volumeBindingMode</span>:<span style=color:#666> </span>Immediate<span style=color:#666>
</span></code></pre></div><h2 id=创建-statefulset>创建 StatefulSet </h2><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#6ab825;font-weight:700>apiVersion</span>:<span style=color:#666> </span>apps/v1<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>kind</span>:<span style=color:#666> </span>StatefulSet<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>metadata</span>:<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>mysql-backend<span style=color:#666>
</span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>spec</span>:<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>selector</span>:<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>matchLabels</span>:<span style=color:#666>
</span><span style=color:#666>      </span><span style=color:#6ab825;font-weight:700>app</span>:<span style=color:#666> </span>mysql<span style=color:#666> </span><span style=color:#999;font-style:italic># 匹配 .spec.template.metadata.labels</span><span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>serviceName</span>:<span style=color:#666> </span>mysql-svc-master<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>replicas</span>:<span style=color:#666> </span><span style=color:#3677a9>1</span><span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>template</span>:<span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>metadata</span>:<span style=color:#666>
</span><span style=color:#666>      </span><span style=color:#6ab825;font-weight:700>labels</span>:<span style=color:#666>
</span><span style=color:#666>        </span><span style=color:#6ab825;font-weight:700>app</span>:<span style=color:#666> </span>mysql<span style=color:#666> </span><span style=color:#999;font-style:italic># 匹配 .spec.selector.matchLabels</span><span style=color:#666>
</span><span style=color:#666>    </span><span style=color:#6ab825;font-weight:700>spec</span>:<span style=color:#666>
</span><span style=color:#666>      </span><span style=color:#6ab825;font-weight:700>initContainers</span>:<span style=color:#666>
</span><span style=color:#666>        </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>init-mysql<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>image</span>:<span style=color:#666> </span>mysql:8.0<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>command</span>:<span style=color:#666>
</span><span style=color:#666>            </span>- bash<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#ed9d13>&#39;-c&#39;</span><span style=color:#666>
</span><span style=color:#666>            </span>- |<span style=color:#ed9d13>
</span><span style=color:#ed9d13>              set ex
</span><span style=color:#ed9d13>              # Generate mysql server-id from pod ordinal index.
</span><span style=color:#ed9d13>              [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
</span><span style=color:#ed9d13>              ordinal=${BASH_REMATCH[1]}
</span><span style=color:#ed9d13>              echo [mysqld] &gt; /mnt/conf.d/server-id.cnf
</span><span style=color:#ed9d13>              # Add an offset to avoid reserved server-id=0 value.
</span><span style=color:#ed9d13>              echo server-id=$((100 + $ordinal)) &gt;&gt; /mnt/conf.d/server-id.cnf
</span><span style=color:#ed9d13>              # Copy appropriate conf.d files from config-map to emptyDir.
</span><span style=color:#ed9d13>              if [[ $ordinal -eq 0 ]]; then
</span><span style=color:#ed9d13>                cp /mnt/config-map/master.cnf /mnt/conf.d/
</span><span style=color:#ed9d13>              else
</span><span style=color:#ed9d13>                cp /mnt/config-map/slave.cnf /mnt/conf.d/
</span><span style=color:#ed9d13>              fi</span><span style=color:#666>              
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>volumeMounts</span>:<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>conf<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>mountPath</span>:<span style=color:#666> </span>/mnt/conf.d<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>config-map<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>mountPath</span>:<span style=color:#666> </span>/mnt/config-map<span style=color:#666>
</span><span style=color:#666>        </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>clone-mysql<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>image</span>:<span style=color:#666> </span>mzmuer/xtrabackup:1.0<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>command</span>:<span style=color:#666>
</span><span style=color:#666>            </span>- bash<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#ed9d13>&#39;-c&#39;</span><span style=color:#666>
</span><span style=color:#666>            </span>- |<span style=color:#ed9d13>
</span><span style=color:#ed9d13>              set -ex
</span><span style=color:#ed9d13>              # Skip the clone if data already exists.
</span><span style=color:#ed9d13>              [[ -d /var/lib/mysql/mysql ]] &amp;&amp; exit 0
</span><span style=color:#ed9d13>              # Skip the clone on master (ordinal index 0).
</span><span style=color:#ed9d13>              [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
</span><span style=color:#ed9d13>              ordinal=${BASH_REMATCH[1]}
</span><span style=color:#ed9d13>              [[ $ordinal -eq 0 ]] &amp;&amp; exit 0
</span><span style=color:#ed9d13>              # Clone data from previous peer.
</span><span style=color:#ed9d13>              ncat --recv-only mysql-ss-$(($ordinal-1)).mysql-svc-master 13306 | xbstream -x -C /var/lib/mysql
</span><span style=color:#ed9d13>              # Prepare the backup.
</span><span style=color:#ed9d13>              xtrabackup --prepare --target-dir=/var/lib/mysql</span><span style=color:#666>              
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>volumeMounts</span>:<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>data<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>mountPath</span>:<span style=color:#666> </span>/var/lib/mysql<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>subPath</span>:<span style=color:#666> </span>mysql<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>conf<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>mountPath</span>:<span style=color:#666> </span>/etc/mysql/conf.d<span style=color:#666>
</span><span style=color:#666>      </span><span style=color:#6ab825;font-weight:700>containers</span>:<span style=color:#666>
</span><span style=color:#666>        </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>mysql<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>image</span>:<span style=color:#666> </span>mysql:8.0<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>args</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;--default-authentication-plugin=mysql_native_password&#39;</span>]<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>env</span>:<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>MYSQL_ROOT_PASSWORD<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>value</span>:<span style=color:#666> </span><span style=color:#ed9d13>&#39;4rt5$RT%&#39;</span><span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>ports</span>:<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>mysql<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>containerPort</span>:<span style=color:#666> </span><span style=color:#3677a9>3306</span><span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>volumeMounts</span>:<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>data<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>mountPath</span>:<span style=color:#666> </span>/var/lib/mysql<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>subPath</span>:<span style=color:#666> </span>mysql<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>conf<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>mountPath</span>:<span style=color:#666> </span>/etc/mysql/conf.d<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>resources</span>:<span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>requests</span>:<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>cpu</span>:<span style=color:#666> </span>250m<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>memory</span>:<span style=color:#666> </span>256Mi<span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>limits</span>:<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>cpu</span>:<span style=color:#666> </span>500m<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>memory</span>:<span style=color:#666> </span>512Mi<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>livenessProbe</span>:<span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>exec</span>:<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>command</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;mysqladmin&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;-uroot&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;-p${MYSQL_ROOT_PASSWORD}&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;ping&#39;</span>]<span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>initialDelaySeconds</span>:<span style=color:#666> </span><span style=color:#3677a9>30</span><span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>periodSeconds</span>:<span style=color:#666> </span><span style=color:#3677a9>10</span><span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>timeoutSeconds</span>:<span style=color:#666> </span><span style=color:#3677a9>5</span><span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>readinessProbe</span>:<span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>exec</span>:<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#999;font-style:italic># Check we can execute queries over TCP (skip-networking is off).</span><span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>command</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;mysqladmin&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;-uroot&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;-p${MYSQL_ROOT_PASSWORD}&#39;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;ping&#39;</span>]<span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>initialDelaySeconds</span>:<span style=color:#666> </span><span style=color:#3677a9>5</span><span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>periodSeconds</span>:<span style=color:#666> </span><span style=color:#3677a9>2</span><span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>timeoutSeconds</span>:<span style=color:#666> </span><span style=color:#3677a9>1</span><span style=color:#666>
</span><span style=color:#666>        </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>xtrabackup<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>image</span>:<span style=color:#666> </span>mzmuer/xtrabackup:1.0<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>ports</span>:<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>xtrabackup<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>containerPort</span>:<span style=color:#666> </span><span style=color:#3677a9>13306</span><span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>command</span>:<span style=color:#666>
</span><span style=color:#666>            </span>- bash<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#ed9d13>&#39;-c&#39;</span><span style=color:#666>
</span><span style=color:#666>            </span>- |<span style=color:#ed9d13>
</span><span style=color:#ed9d13>              set -ex
</span><span style=color:#ed9d13>              cd /var/lib/mysql
</span><span style=color:#ed9d13>              # Determine binlog position of cloned data, if any.
</span><span style=color:#ed9d13>              if [[ -s xtrabackup_slave_info ]]; then
</span><span style=color:#ed9d13>                # XtraBackup already generated a partial &#34;CHANGE MASTER TO&#34; query
</span><span style=color:#ed9d13>                # because we&#39;re cloning from an existing slave.
</span><span style=color:#ed9d13>                mv xtrabackup_slave_info change_master_to.sql.in
</span><span style=color:#ed9d13>                
</span><span style=color:#ed9d13>                # Ignore xtrabackup_binlog_info in this case (it&#39;s useless).
</span><span style=color:#ed9d13>                rm -f xtrabackup_binlog_info
</span><span style=color:#ed9d13>              elif [[ -f xtrabackup_binlog_info ]]; then
</span><span style=color:#ed9d13>                # We&#39;re cloning directly from master. Parse binlog position.
</span><span style=color:#ed9d13>                [[ `cat xtrabackup_binlog_info` =~ ^(.*?)[[:space:]]+(.*?)$ ]] || exit 1
</span><span style=color:#ed9d13>                rm xtrabackup_binlog_info
</span><span style=color:#ed9d13>                echo &#34;CHANGE MASTER TO MASTER_LOG_FILE=&#39;${BASH_REMATCH[1]}&#39;,\
</span><span style=color:#ed9d13>                      MASTER_LOG_POS=${BASH_REMATCH[2]}&#34; &gt; change_master_to.sql.in
</span><span style=color:#ed9d13>              fi
</span><span style=color:#ed9d13>              # Check if we need to complete a clone by starting replication.
</span><span style=color:#ed9d13>              if [[ -f change_master_to.sql.in ]]; then
</span><span style=color:#ed9d13>                echo &#34;Waiting for mysqld to be ready (accepting connections)&#34;
</span><span style=color:#ed9d13>                until mysql -h 127.0.0.1 -e &#34;SELECT 1&#34;; do sleep 1; done
</span><span style=color:#ed9d13>                echo &#34;Initializing replication from clone position&#34;
</span><span style=color:#ed9d13>                # In case of container restart, attempt this at-most-once.
</span><span style=color:#ed9d13>                mv change_master_to.sql.in change_master_to.sql.orig
</span><span style=color:#ed9d13>                mysql -h 127.0.0.1 &lt;&lt;EOF
</span><span style=color:#ed9d13>              $(&lt;change_master_to.sql.orig),
</span><span style=color:#ed9d13>                MASTER_HOST=&#39;mysql-ss-0.mysql-svc-master&#39;,
</span><span style=color:#ed9d13>                MASTER_USER=&#39;root&#39;,
</span><span style=color:#ed9d13>                MASTER_PASSWORD=&#39;&#39;,
</span><span style=color:#ed9d13>                MASTER_CONNECT_RETRY=10;
</span><span style=color:#ed9d13>              START SLAVE;
</span><span style=color:#ed9d13>              EOF
</span><span style=color:#ed9d13>              fi
</span><span style=color:#ed9d13>              # Start a server to send backups when requested by peers.
</span><span style=color:#ed9d13>              exec ncat --listen --keep-open --send-only --max-conns=1 13306 -c \
</span><span style=color:#ed9d13>                &#34;xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root&#34;</span><span style=color:#666>              
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>volumeMounts</span>:<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>data<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>mountPath</span>:<span style=color:#666> </span>/var/lib/mysql<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>subPath</span>:<span style=color:#666> </span>mysql<span style=color:#666>
</span><span style=color:#666>            </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>conf<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>mountPath</span>:<span style=color:#666> </span>/etc/mysql/conf.d<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>resources</span>:<span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>requests</span>:<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>cpu</span>:<span style=color:#666> </span>100m<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>memory</span>:<span style=color:#666> </span>100Mi<span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>limits</span>:<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>cpu</span>:<span style=color:#666> </span>200m<span style=color:#666>
</span><span style=color:#666>              </span><span style=color:#6ab825;font-weight:700>memory</span>:<span style=color:#666> </span>200Mi<span style=color:#666>
</span><span style=color:#666>      </span><span style=color:#6ab825;font-weight:700>volumes</span>:<span style=color:#666>
</span><span style=color:#666>        </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>conf<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>emptyDir</span>:<span style=color:#666> </span>{}<span style=color:#666>
</span><span style=color:#666>        </span>- <span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>config-map<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>configMap</span>:<span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>mysql<span style=color:#666>
</span><span style=color:#666>  </span><span style=color:#6ab825;font-weight:700>volumeClaimTemplates</span>:<span style=color:#666>
</span><span style=color:#666>    </span>- <span style=color:#6ab825;font-weight:700>metadata</span>:<span style=color:#666>
</span><span style=color:#666>        </span><span style=color:#6ab825;font-weight:700>name</span>:<span style=color:#666> </span>data<span style=color:#666>
</span><span style=color:#666>      </span><span style=color:#6ab825;font-weight:700>spec</span>:<span style=color:#666>
</span><span style=color:#666>        </span><span style=color:#6ab825;font-weight:700>storageClassName</span>:<span style=color:#666> </span><span style=color:#ed9d13>&#39;mysql-storage&#39;</span><span style=color:#666>
</span><span style=color:#666>        </span><span style=color:#6ab825;font-weight:700>accessModes</span>:<span style=color:#666> </span>[<span style=color:#ed9d13>&#39;ReadWriteOnce&#39;</span>]<span style=color:#666>
</span><span style=color:#666>        </span><span style=color:#6ab825;font-weight:700>resources</span>:<span style=color:#666>
</span><span style=color:#666>          </span><span style=color:#6ab825;font-weight:700>requests</span>:<span style=color:#666>
</span><span style=color:#666>            </span><span style=color:#6ab825;font-weight:700>storage</span>:<span style=color:#666> </span>10Gi<span style=color:#666>
</span></code></pre></div>
</div>
</article>
</main>
<aside>
<div>
<div>
<h3>LATEST POSTS</h3>
</div>
<div>
<ul>
<li><a href=/image/basic/>image 基础知识</a></li>
<li><a href=/linux/ubuntu/>Ubuntu in docker</a></li>
<li><a href=/kubernetes/scheduler/>kubernetes scheduler</a></li>
<li><a href=/docker/create/>从零开始实现一个可用的 docker</a></li>
<li><a href=/kubernetes/mount/>kubernetes 部署</a></li>
</ul>
</div>
</div>
</aside>
<script src=https://utteranc.es/client.js repo=sunweiwe/sunweiwe.github.io issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script>
<footer>
------------------------------------------------------
<p>&copy; 2023
<a class=footer-link href=https://sunweiwe.github.io></a>
| <a class=footer-link href=https://github.com/sunweiwe><b>GitHub</b></a>
</span>
</p>
</footer>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>