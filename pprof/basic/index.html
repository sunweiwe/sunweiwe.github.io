<!doctype html><html lang=en-us>
<head>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.7.0/style.min.css>
<link rel=stylesheet href=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/default.min.css>
<script defer crossorigin=anonymous src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js onload=hljs.highlightAll()></script>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>pprof</title>
<link rel=stylesheet href=https://sunweiwe.github.io/style.min.d9712c7529c6273cae9cbd0ed688f97cbe37e248317298145303b71169db98c5.css integrity="sha256-2XEsdSnGJzyunL0O1oj5fL434kgxcpgUUwO3EWnbmMU=" media=screen>
<link rel="shortcut icon" type=image/x-icon href=favicon.ico>
</head>
<body>
<script>localStorage.getItem("prefer-theme")==="light"&&document.body.classList.remove('dark')</script>
<header>
<div class=header-common>
<div>
┏━━━━━━━━━━━━━━━┓<br>
┇ <a class=logo href=https://sunweiwe.github.io/>sunweiwe/blog</a> ┇
<button id=theme-toggle text=toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<br>
┗━━━━━━━━━━━━━━━┛
</div>
<div>关于代码，关于生活.</div><br>
</div>
<p>
<nav>
<a href=https://sunweiwe.github.io/><b>Home</b></a>
| <a href=/posts/><b>Posts</b></a>
| <a href=/tags/><b>Tags</b></a>
| <a href=/search/><b>Search</b></a>
</nav>
</p>
</header>
<main>
<article class=post-content>
<h1 class=title>pprof</h1>
<b><time>22.05.2022</time></b>
<a href=/%20/tags/go>#Go</a>
<a href=/%20/tags/pprof>#pprof</a>
<div>
<p>pprof 工具可以用来监测进程的运行数据，用于监控程序的性能，对内存使用和 CPU 使用的情况统信息进行分析。</p>
<h2 id=pprof-是什么>pprof 是什么？ </h2><p>pprof 工具可以用来监测进程的运行数据，用于监控程序的性能，对内存使用和 CPU 使用的情况统信息进行分析。</p>
<h2 id=采样方式>采样方式 </h2><ul>
<li>runtime/pprof：采集程序（非 Server）的指定区块的运行数据进行分析。</li>
<li>net/http/pprof：基于 HTTP Server 运行，并且可以采集运行时数据进行分析。</li>
<li>go test：通过运行测试用例，并指定所需标识来进行采集。</li>
</ul>
<h2 id=使用模式>使用模式 </h2><ul>
<li>Report generation：报告生成。</li>
<li>Interactive terminal use：交互式终端使用。
(go tool pprof http://localhost:6060/debug/pprof/profile/(allocs|blocks|goroutine|etc..))
<ul>
<li>top</li>
<li>list</li>
<li>web</li>
</ul>
</li>
<li>Web interface：Web 界面。</li>
</ul>
<h2 id=使用方式>使用方式 </h2><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#6ab825;font-weight:700>package</span> main

<span style=color:#6ab825;font-weight:700>import</span> (
	<span style=color:#999;font-style:italic>// 略
</span><span style=color:#999;font-style:italic></span>	_ <span style=color:#ed9d13>&#34;net/http/pprof&#34;</span> <span style=color:#999;font-style:italic>// 会自动注册 handler 到 http server，方便通过 http 接口获取程序运行采样报告
</span><span style=color:#999;font-style:italic></span>	<span style=color:#999;font-style:italic>// 略
</span><span style=color:#999;font-style:italic></span>)

<span style=color:#6ab825;font-weight:700>func</span> <span style=color:#447fcf>main</span>() {
	<span style=color:#999;font-style:italic>// 略
</span><span style=color:#999;font-style:italic></span>
	runtime.<span style=color:#447fcf>GOMAXPROCS</span>(<span style=color:#3677a9>1</span>) <span style=color:#999;font-style:italic>// 限制 CPU 使用数，避免过载
</span><span style=color:#999;font-style:italic></span>	runtime.<span style=color:#447fcf>SetMutexProfileFraction</span>(<span style=color:#3677a9>1</span>) <span style=color:#999;font-style:italic>// 开启对锁调用的跟踪
</span><span style=color:#999;font-style:italic></span>	runtime.<span style=color:#447fcf>SetBlockProfileRate</span>(<span style=color:#3677a9>1</span>) <span style=color:#999;font-style:italic>// 开启对阻塞操作的跟踪
</span><span style=color:#999;font-style:italic></span>
	<span style=color:#6ab825;font-weight:700>go</span> <span style=color:#6ab825;font-weight:700>func</span>() {
		<span style=color:#999;font-style:italic>// 启动一个 http server，注意 pprof 相关的 handler 已经自动注册过了
</span><span style=color:#999;font-style:italic></span>		<span style=color:#6ab825;font-weight:700>if</span> err := http.<span style=color:#447fcf>ListenAndServe</span>(<span style=color:#ed9d13>&#34;:6060&#34;</span>, <span style=color:#6ab825;font-weight:700>nil</span>); err != <span style=color:#6ab825;font-weight:700>nil</span> {
			log.<span style=color:#447fcf>Fatal</span>(err)
		}
		os.<span style=color:#447fcf>Exit</span>(<span style=color:#3677a9>0</span>)
	}()
}

</code></pre></div><h2 id=采集数据类型>采集数据类型 </h2><ul>
<li>allocs 内存分配情况的采样信息</li>
<li>blocks 阻塞操作情况的采样信息</li>
<li>cmdline 显示程序启动命令及参数</li>
<li>goroutine 当前所有协程的堆栈信息</li>
<li>heap 堆上内存使用情况的采样信息</li>
<li>mutex 锁争用情况的采样信息</li>
<li>profile CPU 占用情况的采样信息</li>
<li>threadcreate 系统线程创建情况的采样信息</li>
<li>trace 程序运行跟踪信</li>
</ul>
</div>
</article>
</main>
<aside>
<div>
<div>
<h3>LATEST POSTS</h3>
</div>
<div>
<ul>
<li><a href=/image/basic/>image 基础知识</a></li>
<li><a href=/linux/ubuntu/>Ubuntu in docker</a></li>
<li><a href=/kubernetes/scheduler/>kubernetes scheduler</a></li>
<li><a href=/docker/create/>从零开始实现一个可用的 docker</a></li>
<li><a href=/kubernetes/mount/>kubernetes 部署</a></li>
</ul>
</div>
</div>
</aside>
<script src=https://utteranc.es/client.js repo=sunweiwe/sunweiwe.github.io issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script>
<footer>
------------------------------------------------------
<p>&copy; 2023
<a class=footer-link href=https://sunweiwe.github.io></a>
| <a class=footer-link href=https://github.com/sunweiwe><b>GitHub</b></a>
</span>
</p>
</footer>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>