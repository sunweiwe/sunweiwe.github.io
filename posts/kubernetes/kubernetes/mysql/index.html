<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
kubernetes 使用 stateful 方式部署 mysql"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:title" content="stateful 部署 mysql"><meta property="og:description" content="
kubernetes 使用 stateful 方式部署 mysql"><meta property="og:type" content="article"><meta property="og:url" content="https://sunweiwe.github.io/posts/kubernetes/kubernetes/mysql/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-24T21:39:36+08:00"><meta property="article:modified_time" content="2023-07-20T22:53:08+08:00"><title>stateful 部署 mysql | sunweiwe/blog</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.min.4f0117e74e5337280f18eb9641eae520cb4b25adcf5dd64fafad4664145a5957.css integrity="sha256-TwEX505TNygPGOuWQerlIMtLJa3PXdZPr61GZBRaWVc=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.1b2bf308793e524c7bd66e1d113796241ab6ddb1a1506b85efbaca90f34d339f.js integrity="sha256-GyvzCHk+Ukx71m4dETeWJBq23bGhUGuF77rKkPNNM58=" crossorigin=anonymous></script>
<script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>sunweiwe/blog</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/posts/>Blog</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>stateful 部署 mysql</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#部署-nfs-server>部署 nfs server</a></li><li><a href=#创建-rabc>创建 RABC</a><ul><li><a href=#用户创建-nfs-client>用户创建 nfs client</a></li></ul></li><li><a href=#部署-nfs-client>部署 nfs client</a><ul><li><a href=#用于自动创建-pvc>用于自动创建 pvc</a></li></ul></li><li><a href=#创建-storageclass>创建 StorageClass</a><ul><li><a href=#用于-mysql-自动扩容或者所容绑定-pvc>用于 mysql 自动扩容或者所容绑定 pvc</a></li></ul></li><li><a href=#创建-statefulset>创建 StatefulSet</a></li></ul></li></ul></nav></aside></header><article class="markdown book-post"><h1><a href=/posts/kubernetes/kubernetes/mysql/>stateful 部署 mysql</a></h1><h5>October 24, 2022</h5><div><a href=/tags/kubernetes/>kubernetes</a></div><p>kubernetes 使用 stateful 方式部署 mysql</p><h2 id=部署-nfs-server>部署 nfs server
<a class=anchor href=#%e9%83%a8%e7%bd%b2-nfs-server>#</a></h2><ul><li>安装软件包</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install -y rpcbind nfs-utils
</span></span></code></pre></div><ul><li>修改 /etc/exports</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  /hone/nfs/ <span style=color:#ae81ff>\*</span><span style=color:#f92672>(</span>insecure,rw,sync,no_root_squash<span style=color:#f92672>)</span>
</span></span></code></pre></div><ul><li>启动 nfs 服务</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /home/nfs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl enable rpcbind
</span></span><span style=display:flex><span>systemctl enable nfs-server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>systemctl start rpcbind
</span></span><span style=display:flex><span>systemctl start nfs-server
</span></span><span style=display:flex><span>exportfs -r
</span></span><span style=display:flex><span>exportfs
</span></span></code></pre></div><h2 id=创建-rabc>创建 RABC
<a class=anchor href=#%e5%88%9b%e5%bb%ba-rabc>#</a></h2><h3 id=用户创建-nfs-client>用户创建 nfs client
<a class=anchor href=#%e7%94%a8%e6%88%b7%e5%88%9b%e5%bb%ba-nfs-client>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-client-provisioner</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRole</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-client-provisioner-runner</span>
</span></span><span style=display:flex><span><span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>apiGroups</span>: [<span style=color:#e6db74>&#39;&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>resources</span>: [<span style=color:#e6db74>&#39;persistentvolumes&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>verbs</span>: [<span style=color:#e6db74>&#39;get&#39;</span>, <span style=color:#e6db74>&#39;list&#39;</span>, <span style=color:#e6db74>&#39;watch&#39;</span>, <span style=color:#e6db74>&#39;create&#39;</span>, <span style=color:#e6db74>&#39;delete&#39;</span>]
</span></span><span style=display:flex><span>  - <span style=color:#f92672>apiGroups</span>: [<span style=color:#e6db74>&#39;&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>resources</span>: [<span style=color:#e6db74>&#39;persistentvolumeclaims&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>verbs</span>: [<span style=color:#e6db74>&#39;get&#39;</span>, <span style=color:#e6db74>&#39;list&#39;</span>, <span style=color:#e6db74>&#39;watch&#39;</span>, <span style=color:#e6db74>&#39;update&#39;</span>]
</span></span><span style=display:flex><span>  - <span style=color:#f92672>apiGroups</span>: [<span style=color:#e6db74>&#39;storage.k8s.io&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>resources</span>: [<span style=color:#e6db74>&#39;storageclasses&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>verbs</span>: [<span style=color:#e6db74>&#39;get&#39;</span>, <span style=color:#e6db74>&#39;list&#39;</span>, <span style=color:#e6db74>&#39;watch&#39;</span>]
</span></span><span style=display:flex><span>  - <span style=color:#f92672>apiGroups</span>: [<span style=color:#e6db74>&#39;&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>resources</span>: [<span style=color:#e6db74>&#39;events&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>verbs</span>: [<span style=color:#e6db74>&#39;create&#39;</span>, <span style=color:#e6db74>&#39;update&#39;</span>, <span style=color:#e6db74>&#39;patch&#39;</span>]
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>run-nfs-client-provisioner</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subjects</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-client-provisioner</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ClusterRole</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-client-provisioner-runner</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Role</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>leader-locking-nfs-client-provisioner</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>apiGroups</span>: [<span style=color:#e6db74>&#39;&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>resources</span>: [<span style=color:#e6db74>&#39;endpoints&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>verbs</span>: [<span style=color:#e6db74>&#39;get&#39;</span>, <span style=color:#e6db74>&#39;list&#39;</span>, <span style=color:#e6db74>&#39;watch&#39;</span>, <span style=color:#e6db74>&#39;create&#39;</span>, <span style=color:#e6db74>&#39;update&#39;</span>, <span style=color:#e6db74>&#39;patch&#39;</span>]
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>RoleBinding</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>leader-locking-nfs-client-provisioner</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>subjects</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-client-provisioner</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Role</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>leader-locking-nfs-client-provisioner</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</span></span></code></pre></div><h2 id=部署-nfs-client>部署 nfs client
<a class=anchor href=#%e9%83%a8%e7%bd%b2-nfs-client>#</a></h2><h3 id=用于自动创建-pvc>用于自动创建 pvc
<a class=anchor href=#%e7%94%a8%e4%ba%8e%e8%87%aa%e5%8a%a8%e5%88%9b%e5%bb%ba-pvc>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-client-provisioner</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nfs-client-provisioner</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>strategy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>Recreate</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nfs-client-provisioner</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nfs-client-provisioner</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>serviceAccountName</span>: <span style=color:#ae81ff>nfs-client-provisioner</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-client-provisioner</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry.cn-hangzhou.aliyuncs.com/jimywu/nfs-subdir-external-provisioner:v4.0.0</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-client-root</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/persistentvolumes</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>PROVISIONER_NAME</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>value</span>: <span style=color:#ae81ff>k8s-sigs.io/nfs-subdir-external-provisioner</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>NFS_SERVER</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>value</span>: <span style=color:#ae81ff>10.0.24.13</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>NFS_PATH</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>value</span>: <span style=color:#ae81ff>/home/nfs</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nfs-client-root</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>nfs</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>server</span>: <span style=color:#ae81ff>10.0.24.13</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/home/nfs</span>
</span></span></code></pre></div><h2 id=创建-storageclass>创建 StorageClass
<a class=anchor href=#%e5%88%9b%e5%bb%ba-storageclass>#</a></h2><h3 id=用于-mysql-自动扩容或者所容绑定-pvc>用于 mysql 自动扩容或者所容绑定 pvc
<a class=anchor href=#%e7%94%a8%e4%ba%8e-mysql-%e8%87%aa%e5%8a%a8%e6%89%a9%e5%ae%b9%e6%88%96%e8%80%85%e6%89%80%e5%ae%b9%e7%bb%91%e5%ae%9a-pvc>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>storage.k8s.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>StorageClass</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mysql-storage</span>
</span></span><span style=display:flex><span><span style=color:#f92672>provisioner</span>: <span style=color:#ae81ff>k8s-sigs.io/nfs-subdir-external-provisioner</span>
</span></span><span style=display:flex><span><span style=color:#f92672>reclaimPolicy</span>: <span style=color:#ae81ff>Retain</span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumeBindingMode</span>: <span style=color:#ae81ff>Immediate</span>
</span></span></code></pre></div><h2 id=创建-statefulset>创建 StatefulSet
<a class=anchor href=#%e5%88%9b%e5%bb%ba-statefulset>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>StatefulSet</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mysql-backend</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>mysql</span> <span style=color:#75715e># 匹配 .spec.template.metadata.labels</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>serviceName</span>: <span style=color:#ae81ff>mysql-svc-master</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>mysql</span> <span style=color:#75715e># 匹配 .spec.selector.matchLabels</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>initContainers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>init-mysql</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>mysql:8.0</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>bash</span>
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#39;-c&#39;</span>
</span></span><span style=display:flex><span>            - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              set ex
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              # Generate mysql server-id from pod ordinal index.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              ordinal=${BASH_REMATCH[1]}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              echo [mysqld] &gt; /mnt/conf.d/server-id.cnf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              # Add an offset to avoid reserved server-id=0 value.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              echo server-id=$((100 + $ordinal)) &gt;&gt; /mnt/conf.d/server-id.cnf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              # Copy appropriate conf.d files from config-map to emptyDir.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              if [[ $ordinal -eq 0 ]]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                cp /mnt/config-map/master.cnf /mnt/conf.d/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                cp /mnt/config-map/slave.cnf /mnt/conf.d/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              fi</span>              
</span></span><span style=display:flex><span>          <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>conf</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/mnt/conf.d</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config-map</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/mnt/config-map</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>clone-mysql</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>mzmuer/xtrabackup:1.0</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>bash</span>
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#39;-c&#39;</span>
</span></span><span style=display:flex><span>            - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              set -ex
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              # Skip the clone if data already exists.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              [[ -d /var/lib/mysql/mysql ]] &amp;&amp; exit 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              # Skip the clone on master (ordinal index 0).
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              ordinal=${BASH_REMATCH[1]}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              [[ $ordinal -eq 0 ]] &amp;&amp; exit 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              # Clone data from previous peer.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              ncat --recv-only mysql-ss-$(($ordinal-1)).mysql-svc-master 13306 | xbstream -x -C /var/lib/mysql
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              # Prepare the backup.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              xtrabackup --prepare --target-dir=/var/lib/mysql</span>              
</span></span><span style=display:flex><span>          <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>data</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/var/lib/mysql</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>subPath</span>: <span style=color:#ae81ff>mysql</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>conf</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/etc/mysql/conf.d</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mysql</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>mysql:8.0</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>args</span>: [<span style=color:#e6db74>&#39;--default-authentication-plugin=mysql_native_password&#39;</span>]
</span></span><span style=display:flex><span>          <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>MYSQL_ROOT_PASSWORD</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#39;4rt5$RT%&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mysql</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>3306</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>data</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/var/lib/mysql</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>subPath</span>: <span style=color:#ae81ff>mysql</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>conf</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/etc/mysql/conf.d</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>250m</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>256Mi</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>limits</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>500m</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>512Mi</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#39;mysqladmin&#39;</span>, <span style=color:#e6db74>&#39;-uroot&#39;</span>, <span style=color:#e6db74>&#39;-p${MYSQL_ROOT_PASSWORD}&#39;</span>, <span style=color:#e6db74>&#39;ping&#39;</span>]
</span></span><span style=display:flex><span>            <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>readinessProbe</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>exec</span>:
</span></span><span style=display:flex><span>              <span style=color:#75715e># Check we can execute queries over TCP (skip-networking is off).</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#39;mysqladmin&#39;</span>, <span style=color:#e6db74>&#39;-uroot&#39;</span>, <span style=color:#e6db74>&#39;-p${MYSQL_ROOT_PASSWORD}&#39;</span>, <span style=color:#e6db74>&#39;ping&#39;</span>]
</span></span><span style=display:flex><span>            <span style=color:#f92672>initialDelaySeconds</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>periodSeconds</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>timeoutSeconds</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>xtrabackup</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>mzmuer/xtrabackup:1.0</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>xtrabackup</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>13306</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>bash</span>
</span></span><span style=display:flex><span>            - <span style=color:#e6db74>&#39;-c&#39;</span>
</span></span><span style=display:flex><span>            - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              set -ex
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              cd /var/lib/mysql
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              # Determine binlog position of cloned data, if any.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              if [[ -s xtrabackup_slave_info ]]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                # XtraBackup already generated a partial &#34;CHANGE MASTER TO&#34; query
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                # because we&#39;re cloning from an existing slave.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                mv xtrabackup_slave_info change_master_to.sql.in
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                # Ignore xtrabackup_binlog_info in this case (it&#39;s useless).
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                rm -f xtrabackup_binlog_info
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              elif [[ -f xtrabackup_binlog_info ]]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                # We&#39;re cloning directly from master. Parse binlog position.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                [[ `cat xtrabackup_binlog_info` =~ ^(.*?)[[:space:]]+(.*?)$ ]] || exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                rm xtrabackup_binlog_info
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                echo &#34;CHANGE MASTER TO MASTER_LOG_FILE=&#39;${BASH_REMATCH[1]}&#39;,\
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                      MASTER_LOG_POS=${BASH_REMATCH[2]}&#34; &gt; change_master_to.sql.in
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              # Check if we need to complete a clone by starting replication.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              if [[ -f change_master_to.sql.in ]]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                echo &#34;Waiting for mysqld to be ready (accepting connections)&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                until mysql -h 127.0.0.1 -e &#34;SELECT 1&#34;; do sleep 1; done
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                echo &#34;Initializing replication from clone position&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                # In case of container restart, attempt this at-most-once.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                mv change_master_to.sql.in change_master_to.sql.orig
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                mysql -h 127.0.0.1 &lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              $(&lt;change_master_to.sql.orig),
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                MASTER_HOST=&#39;mysql-ss-0.mysql-svc-master&#39;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                MASTER_USER=&#39;root&#39;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                MASTER_PASSWORD=&#39;&#39;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                MASTER_CONNECT_RETRY=10;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              START SLAVE;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              # Start a server to send backups when requested by peers.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              exec ncat --listen --keep-open --send-only --max-conns=1 13306 -c \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &#34;xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root&#34;</span>              
</span></span><span style=display:flex><span>          <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>data</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/var/lib/mysql</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>subPath</span>: <span style=color:#ae81ff>mysql</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>conf</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/etc/mysql/conf.d</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>100m</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>100Mi</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>limits</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>200m</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>200Mi</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>conf</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>emptyDir</span>: {}
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config-map</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>configMap</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mysql</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumeClaimTemplates</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>data</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>storageClassName</span>: <span style=color:#e6db74>&#39;mysql-storage&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>accessModes</span>: [<span style=color:#e6db74>&#39;ReadWriteOnce&#39;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>10Gi</span>
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#部署-nfs-server>部署 nfs server</a></li><li><a href=#创建-rabc>创建 RABC</a><ul><li><a href=#用户创建-nfs-client>用户创建 nfs client</a></li></ul></li><li><a href=#部署-nfs-client>部署 nfs client</a><ul><li><a href=#用于自动创建-pvc>用于自动创建 pvc</a></li></ul></li><li><a href=#创建-storageclass>创建 StorageClass</a><ul><li><a href=#用于-mysql-自动扩容或者所容绑定-pvc>用于 mysql 自动扩容或者所容绑定 pvc</a></li></ul></li><li><a href=#创建-statefulset>创建 StatefulSet</a></li></ul></li></ul></nav></div></aside></main></body></html>